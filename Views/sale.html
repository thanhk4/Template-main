<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <title>Qu·∫£n l√Ω Sale</title>
    <style>
        /* CƒÉn gi·ªØa to√†n b·ªô n·ªôi dung */
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin: 0 auto;
        }
        h2{
            text-align: center;
        }

        /* CƒÉn gi·ªØa c√°c ph·∫ßn t·ª≠ trong b·∫£ng */
        table, th, td {
            text-align: center;
            vertical-align: middle;
        }

        /* Styling cho c√¥ng t·∫Øc tr·∫°ng th√°i */
        .custom-switch input {
            display: none;
        }
        .custom-switch .slider {
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .custom-switch .slider::before {
            content: "";
            width: 22px;
            height: 22px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 1px;
            left: 1px;
            transition: transform 0.2s;
        }
        .custom-switch input:checked + .slider {
            background-color: #28a745;
        }
        .custom-switch input:checked + .slider::before {
            transform: translateX(26px);
        }
       
        
        .action-icons {
            cursor: pointer;
            margin-right: 10px;
        }
        .stop-checkbox {
            cursor: pointer;
        } .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .toggle-switch input {
        display: none;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
    }
     .blue-divider {
        border-top: 1px solid #007bff;
        margin: 20px 0;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #28a745;
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">DANH S√ÅCH CH∆Ø∆†NG TR√åNH SALE</h2>
        <button id="btnAddSale" onclick="showAddSaleForm()" class="btn btn-primary mb-3 float-right">Th√™m ch∆∞∆°ng tr√¨nh Sale</button>

        
        
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>T√™n</th>
                    <th>M√¥ t·∫£</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                    <th>Ng√†y k·∫øt th√∫c</th>
                    <th>H√†nh ƒë·ªông</th>
                    <th>D·ª´ng ph√°t h√†nh</th>
                </tr>
            </thead>
            <tbody id="saleTableBody">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y t·ª´ JavaScript -->
            </tbody>
        </table>
    </div>
    


     <!-- Modal xem chi ti·∫øt ch∆∞∆°ng tr√¨nh Sale -->
     <div id="viewSaleModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi ti·∫øt ch∆∞∆°ng tr√¨nh Sale</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="ƒê√≥ng">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p><strong>T√™n:</strong> <span id="viewSaleName"></span></p>
                    <p><strong>M√¥ t·∫£:</strong> <span id="viewSaleDescription"></span></p>
                    <p><strong>Tr·∫°ng th√°i:</strong> <span id="viewSaleStatus"></span></p>
                    <p><strong>Ng√†y b·∫Øt ƒë·∫ßu:</strong> <span id="viewSaleStartDate"></span></p>
                    <p><strong>Ng√†y k·∫øt th√∫c:</strong> <span id="viewSaleEndDate"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Form th√™m ch∆∞∆°ng tr√¨nh Sale -->
    <div id="addEditSaleModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Th√™m ch∆∞∆°ng tr√¨nh Sale</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="ƒê√≥ng">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addEditSaleForm">
                        <div class="form-group">
                            <label for="ten">T√™n:</label>
                            <input type="text" class="form-control" id="ten" required>
                        </div>
                        <div class="form-group">
                            <label for="mota">M√¥ t·∫£:</label>
                            <textarea class="form-control" id="mota"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="ngaybatdau">Ng√†y b·∫Øt ƒë·∫ßu:</label>
                            <input type="datetime-local" class="form-control" id="ngaybatdau" required>
                        </div>
                        <div class="form-group">
                            <label for="ngayketthuc">Ng√†y k·∫øt th√∫c:</label>
                            <input type="datetime-local" class="form-control" id="ngayketthuc" required>
                        </div>
                        <div class="alert alert-danger d-none" id="error-message"></div>
                    </form>
                </div>
                <!-- ƒê∆∞·ªùng line ph√¢n c√°ch m√†u xanh -->
                <hr class="blue-divider">

        <!-- Ph·∫ßn Th√¥ng tin sale -->

                <div class="form-group">
                    <label>Ph·∫°m vi √°p d·ª•ng:</label>
                    <div>
                        <input type="radio" name="phamvi" id="toanbo" value="toanbo" checked>
                        <label for="toanbo">To√†n b·ªô c·ª≠a h√†ng</label>
                    </div>
                    <div>
                        <input type="radio" name="phamvi" id="nangcao" value="nangcao">
                        <label for="nangcao">Ph·∫°m vi n√¢ng cao</label>
                    </div>
                </div>
                
                <!-- Chi ti·∫øt ph·∫°m vi n√¢ng cao (·∫©n m·∫∑c ƒë·ªãnh) -->
                <div id="phamViNangCaoOptions" style="display: none;">
                    <div class="form-group">
                        <label>Ch·ªçn ph·∫°m vi chi ti·∫øt:</label>
                        <div>
                            <input type="checkbox" id="sanphamCheckbox" name="nangcaoOption" value="sanpham">
                            <label for="sanphamCheckbox">S·∫£n ph·∫©m</label>
                        </div>
                        <div id="sanphamOptions" style="display: none; margin-left: 20px;">
                            <!-- √î t√¨m ki·∫øm s·∫£n ph·∫©m -->
                            <input type="text" id="searchSanPham" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." class="form-control mb-2">
                            <div id="productList">
                                <!-- Danh s√°ch s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                            </div>
                        </div>
                
                        <div>
                            <input type="checkbox" id="sanphamchitietCheckbox" name="nangcaoOption" value="sanphamchitiet">
                            <label for="sanphamchitietCheckbox">√Åp d·ª•ng cho s·∫£n ph·∫©m chi ti·∫øt</label>
                        </div>
                        <div id="sanphamChiTietOptions" style="display: none; margin-left: 20px;">
                            <!-- √î t√¨m ki·∫øm s·∫£n ph·∫©m chi ti·∫øt -->
                            <input type="text" id="searchSanPhamChiTiet" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m chi ti·∫øt..." class="form-control mb-2">
                            <div id="productDetailList">
                                <!-- Danh s√°ch s·∫£n ph·∫©m chi ti·∫øt s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="btnSaveSale">L∆∞u</button>
                </div>
            </div>
        </div>


    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // H√†m ƒë·ªÉ l·∫•y danh s√°ch ch∆∞∆°ng tr√¨nh sale t·ª´ API
            function getSales() {
                $.ajax({
                    url: 'https://localhost:7297/api/Sale',
                    method: 'GET',
                    success: function(data) {
                        var rows = '';
                        data.forEach(function(sale, index) {
                            console.log("ƒê·ªëi t∆∞·ª£ng Sale:", sale); 
                            rows += '<tr>';
                            rows += '<td>' + (index + 1) + '</td>';
                            rows += '<td>' + sale.ten + '</td>'; 
                            rows += '<td>' + (sale.mota || 'Kh√¥ng c√≥') + '</td>'; 
                            rows += '<td>' + sale.trangthai + '</td>'; 
                            rows += '<td>' + new Date(sale.ngaybatdau).toLocaleString() + '</td>'; 
                            rows += '<td>' + new Date(sale.ngayketthuc).toLocaleString() + '</td>'; 
                            rows += '<td>';
                            rows += '<span class="action-icons" onclick="viewSale(' + sale.id + ')">üëÅÔ∏è</span>';
                            rows += '<span class="action-icons" onclick="editSale(' + sale.id + ')">‚úèÔ∏è</span>';
                            rows += '<span class="action-icons" onclick="deleteSale(' + sale.id + ')">üóëÔ∏è</span>';
                            rows += '</td>';
                            rows += '<td><label class="toggle-switch"><input type="checkbox" onclick="stopSale(' + sale.id + ', this)" ' + (sale.trangthai === 'D·ª´ng ph√°t h√†nh' ? 'checked' : '') + '><span class="slider"></span></label></td>';
                            rows += '</tr>';
                        });
                        $('#saleTableBody').html(rows);
                    },
                    error: function(err) {
                        console.error('L·ªói khi l·∫•y danh s√°ch sale:', err);
                    }
                });
            }

            // Chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i th√†nh vƒÉn b·∫£n
            function getStatusText(trangthai) {
                switch(trangthai) {
                    case 0: return 'ƒêang di·ªÖn ra';
                    case 1: return 'Chu·∫©n b·ªã di·ªÖn ra';
                    case 2: return 'ƒê√£ di·ªÖn ra';
                    case 3: return 'D·ª´ng ph√°t h√†nh';
                    default: return 'Kh√¥ng x√°c ƒë·ªãnh';
                }
            }

            // C√°c h√†m ƒë·ªÉ x·ª≠ l√Ω h√†nh ƒë·ªông
            window.viewSale = function(id) {
                $.ajax({
        url: 'https://localhost:7297/api/Sale/' + id, // API l·∫•y chi ti·∫øt sale
        method: 'GET',
        success: function(sale) {
            //console.log(sale);
            // ƒê∆∞a d·ªØ li·ªáu v√†o c√°c ph·∫ßn t·ª≠ trong modal
            $('#viewSaleName').text(sale.ten);
            $('#viewSaleDescription').text(sale.mota || 'Kh√¥ng c√≥ m√¥ t·∫£');
            $('#viewSaleStatus').text(sale.trangthai);
            $('#viewSaleStartDate').text(new Date(sale.ngaybatdau).toLocaleString());
            $('#viewSaleEndDate').text(new Date(sale.ngayketthuc).toLocaleString());

            // Hi·ªÉn th·ªã modal chi ti·∫øt sale
            $('#viewSaleModal').modal('show');
        },
        error: function(err) {
            console.error('L·ªói khi l·∫•y chi ti·∫øt sale:', err);
            alert('Kh√¥ng th·ªÉ l·∫•y chi ti·∫øt sale.');
        }
    });
            };

            window.editSale = function(id) {
                showEditSaleForm(id);
            };

            window.deleteSale = function(id) {
    console.log("ID ƒë·ªÉ x√≥a:", id);
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng tr√¨nh Sale n√†y?')) {
        $.ajax({
            url: 'https://localhost:7297/api/Sale/' + id,
            method: 'DELETE',
            success: function() {
                alert('ƒê√£ x√≥a ch∆∞∆°ng tr√¨nh Sale');
                getSales(); // C·∫≠p nh·∫≠t danh s√°ch sau khi x√≥a
            },
            error: function(err) {
                console.error('L·ªói khi x√≥a ch∆∞∆°ng tr√¨nh Sale:', err);
                alert('Kh√¥ng th·ªÉ x√≥a ch∆∞∆°ng tr√¨nh Sale. M√£ l·ªói: ' + (err.status || 'Kh√¥ng x√°c ƒë·ªãnh'));
            }
        });
    }
    };
            window.stopSale = function(id, checkbox) {
                var isChecked = checkbox.checked;
                var url = isChecked 
                    ? 'https://localhost:7297/api/Sale/' + id + '/cancel'   // API h·ªßy
                    : 'https://localhost:7297/api/Sale/' + id + '/update-status'; // API c·∫≠p nh·∫≠t tr·∫°ng th√°i

                $.ajax({
                    url: url,
                    method: 'PUT',
                    success: function() {
                        var action = isChecked ? 'd·ª´ng ph√°t h√†nh' : 'c·∫≠p nh·∫≠t tr·∫°ng th√°i';
                        alert('ƒê√£ ' + action + ' cho ch∆∞∆°ng tr√¨nh Sale.');
                        getSales(); // C·∫≠p nh·∫≠t danh s√°ch sau khi thay ƒë·ªïi
                    },
                    error: function(err) {
                        console.error('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i:', err);
                        alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i. Vui l√≤ng th·ª≠ l·∫°i.');
                        checkbox.checked = !isChecked; // Kh√¥i ph·ª•c tr·∫°ng th√°i checkbox khi l·ªói
                    }
                });
            };


          //√†m ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i cho t·∫•t c·∫£ c√°c sale
            function updateAllSalesStatus() {
                $.ajax({
                    url: 'https://localhost:7297/api/Sale/', // API ƒë·ªÉ l·∫•y danh s√°ch sale
                    method: 'GET',
                    success: function(sales) {
                        sales.forEach(function(sale) {
                            
                             updateSaleStatus(sale.id); // G·ªçi h√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i
                                //setInterval(() => updateSaleStatus(sale.id), 5000);
                        });
                        
                    },
                    error: function(err) {
                        console.error('L·ªói khi l·∫•y danh s√°ch sale:', err);
                    }
                });
            }

            // H√†m ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i sale
            function updateSaleStatus(saleId) {
                $.ajax({
                    url: 'https://localhost:7297/api/Sale/'+saleId+'/update-status-load',
                    method: 'PUT',
                    success: function() {
                    getSales();

                    },
                    error: function(err) {
                        console.error('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i:', err);
                    }
                });
            }
            // function reloadSalesAfterDelay() {
            //     setTimeout(getSales, 100); // T·∫£i l·∫°i sau 500ms
            // }
            // G·ªçi h√†m ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i cho t·∫•t c·∫£ c√°c sale
            updateAllSalesStatus();
            setInterval(updateAllSalesStatus, 5000); 
            // G·ªçi h√†m ƒë·ªÉ l·∫•y danh s√°ch ch∆∞∆°ng tr√¨nh sale khi trang ƒë∆∞·ª£c t·∫£i
            getSales();
        });
        function showAddSaleForm() {
            isEditMode = false;
            $('#modalTitle').text('Th√™m ch∆∞∆°ng tr√¨nh Sale');
            $('#addEditSaleForm')[0].reset();
            $('#addEditSaleModal').modal('show');
        }

        function showEditSaleForm(id) {
            isEditMode = true;
            editSaleId = id;
            $('#modalTitle').text('S·ª≠a ch∆∞∆°ng tr√¨nh Sale');
            $.ajax({
                url: `https://localhost:7297/api/Sale/${id}`,
                method: 'GET',
                success: function(sale) {
                    $('#ten').val(sale.ten);
                    $('#mota').val(sale.mota);
                    $('#ngaybatdau').val(new Date(sale.ngaybatdau).toISOString().slice(0, 16));
                    $('#ngayketthuc').val(new Date(sale.ngayketthuc).toISOString().slice(0, 16));
                    $('#addEditSaleModal').modal('show');
                },
                error: function(err) { console.error('L·ªói khi l·∫•y d·ªØ li·ªáu sale:', err); }
            });
        }

        $('#btnSaveSale').on('click', function() {
            const saleData = {
                ten: $('#ten').val(),
                mota: $('#mota').val(),
                ngaybatdau: $('#ngaybatdau').val(),
                ngayketthuc: $('#ngayketthuc').val()
            };
            
            const url = isEditMode 
                ? `https://localhost:7297/api/Sale/${editSaleId}`
                : 'https://localhost:7297/api/Sale';
            const method = isEditMode ? 'PUT' : 'POST';
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(saleData),
                success: function() {
                    $('#addEditSaleModal').modal('hide');
                    getSales();
                },
                error: function(err) {
                    console.error('L·ªói khi l∆∞u ch∆∞∆°ng tr√¨nh sale:', err);
                    $('#error-message').text('C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu.').removeClass('d-none');
                }
            });
        });

        $(document).ready(function() {
            getSales();
        });

        $(document).ready(function() {
    // Hi·ªÉn th·ªã c√°c t√πy ch·ªçn ph·∫°m vi n√¢ng cao khi ch·ªçn radio button
    $('input[name="phamvi"]').change(function() {
        if ($('#nangcao').is(':checked')) {
            $('#phamViNangCaoOptions').show();
        } else {
            $('#phamViNangCaoOptions').hide();
            $('#sanphamOptions, #sanphamChiTietOptions').hide();
        }
    });

    // Hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m khi ch·ªçn checkbox
    $('#sanphamCheckbox').change(function() {
        if ($(this).is(':checked')) {
            $('#sanphamOptions').show();
        } else {
            $('#sanphamOptions').hide();
        }
    });

    // Hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m chi ti·∫øt khi ch·ªçn checkbox
    $('#sanphamchitietCheckbox').change(function() {
        if ($(this).is(':checked')) {
            $('#sanphamChiTietOptions').show();
        } else {
            $('#sanphamChiTietOptions').hide();
        }
    });
});


    </script>
</body>
</html>
